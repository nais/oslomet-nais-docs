<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
     <link rel="canonical" href="https://nais.io/oslomet-nais-docs/persistence/postgres/"> 
    
    
    <link rel="icon" type="image/x-icon" href="../../assets/logo.svg">
    

    
    <title>Google Cloud SQL (postgres) - NAIS</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="../../css/highlight.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <header class="navbar fixed-top navbar-expand-md navbar-dark bg-dark">
    <nav class="container-fluid" aria-label="toolbar">
        
        

            
            <a class="navbar-brand" href="../..">
                <img alt="logo" height="36" src="../../assets/logo.svg" class="align-items-center"/>
                 NAIS platform documentation 
            </a>
            

        

        
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle toolbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        

        
        <div class="navbar-collapse collapse" id="navbarSupportedContent">
            <ul class="navbar-nav flex-grow-1 justify-content-end">
                
                    
                    <li class="nav-item d-grid m-1">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal" type="button">
                            <span class="fas fa-search"></span> Search
                        </button>
                    </li> 
                    
                

                
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../buckets/" rel="prev" role="button" class="btn btn-secondary">
                            <span class="fas fa-arrow-left"></span> Previous page
                        </a>
                    </li>
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../bigquery/" rel="next" role="button" class="btn btn-secondary">
                            Next page <span class="fas fa-arrow-right"></span>
                        </a>
                    </li>
                    

                    
                

                
                
                    
                        <li class="nav-item my-auto">
                            <a href="https://github.com/nais/oslomet-nais-docs/" class="btn nav-link">
                                
                                    <span class="fab fa-github"></span> NAIS on Github                                    
                                
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </nav>
</header>

    <div class="container-fluid">
        <div class="row">
            
            
                <aside class="col-md-6 col-lg-3 col-xl-2 order-lg-1" aria-label="primary">


<nav class="mb-5 sticky-top sidebar-sticky" aria-labelledby="nav-label">
    <span id="nav-label" class="fs-4">Navigation:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../..

' aria-current="location"><strong>NAIS</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../..">Introduction to NAIS</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../basics/access/

'> Getting started</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../clusters/gcp/

'> Clusters</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../nais-application/example/

'> NAIS Application</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../naisjob/

'> Naisjob</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../deployment/

'> Deploy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../observability/alerts/



'> Observability</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../responsibilities/

' aria-current="location"><strong>Persistence</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../responsibilities/">Responsibilities</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../kafka/

'> Kafka</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../buckets/">Google Cloud Storage/Buckets</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-warning rounded" href="./" aria-current="page"><strong>Google Cloud SQL (postgres)</strong></a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../bigquery/">Google BigQuery</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../elastic-search/">ElasticSearch</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../open-search/">OpenSearch</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../influxdb/">InfluxDB</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../objectstore/">S3 objectstore</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../redis/">Redis</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../volume-storage/">On-premises disk</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../mq/">MQ</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../mongodb-in-gcp/">MongoDB in GCP</a>
        
    </li>

                 
                
            </ul>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../security/auth/



'> Security</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../addons/leader-election/

'> Addons</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legacy/sunset/

'> Legacy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../appendix/zero-trust/

'> Appendix</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../../support/">Support</a>
        
    </li>

                 
                
            </ul>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../device/

'> naisdevice</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../cli/

'> nais-cli</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legal/roles-responsibilities/

'> Laws and regulations</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../theme-dev/

'> Theme Dev</a>
        
    </li>



        
    </ul>
</nav>


</aside>
                <aside class="col-md-6 col-lg-3 col-xl-3 order-lg-3" aria-label="secondary"><nav class="mb-5 sticky-top sidebar-sticky " aria-labelledby="toc-label">
    <span id="toc-label" class="fs-4">On this page:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#postgres">Postgres</a></strong>
            
            <ul class="ps-3">
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#configuration">Configuration</a>
                    
                    <ul class="ps-3">
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#query-insights">Query Insights</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#maintenance-window">Maintenance window</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#sizing-your-database">Sizing your database</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#automated-backup">Automated backup</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#metrics">Metrics</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#cloud-sql-credentials">Cloud SQL credentials</a>
                    
                    <ul class="ps-3">
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#workaround-for-password-synchronization-issues">Workaround for password synchronization issues</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#reset-database-credentials">Reset database credentials</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#cloud-sql-proxy">Cloud SQL Proxy</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#additional-users-databases">Additional user(s) database(s)</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#personal-database-access">Personal database access</a>
                    
                    <ul class="ps-3">
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#prerequisites">Prerequisites</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#granting-temporary-personal-access">Granting temporary personal access</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#upgrading-major-version">Upgrading major version</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#deleting-the-database">Deleting the database</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#debugging">Debugging</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#example-with-all-configuration-options">Example with all configuration options</a>
                    
                </li>
                
            </ul>
            
        </li>    
        
    </ul>
</nav></aside>
                <main class="col-md-12 col-lg-6 col-xl-7 order-lg-2" aria-label="main content">
<div class="mb-2">
    <a href="https://github.com/nais/oslomet-nais-docs/edit/main/docs/persistence/postgres.md">
        <span class="fas fa-edit"></span> Edit this page
    </a>
</div>


<h1 id="postgres">Postgres<a class="headerlink" href="#postgres" title="Permanent link">§</a></h1>
<p>You can provision and configure <a href="https://www.postgresql.org/">Postgres</a> through <a href="../../nais-application/application/"><code>nais.yaml</code></a>.</p>
<p>The database is provisioned into the teams own project in GCP. Here the team has full access to view logs, create and restore backups and other administrative database tasks.</p>
<p>When you deploy your application with database config, NAIS will ensure the database exists in a <a href="https://cloud.google.com/sql">Google Cloud SQL instance</a> with the specified <a href="https://cloud.google.com/sql/docs/postgres/">Postgres</a> version, and configure the application with means to connect to it.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This feature is only available in GCP clusters. If you need on-prem databases, head over to <a href="https://github.com/navikt/database-iac">navikt/database-iac</a>.</p>
</div>
<p>Below is an example of the minimal configuration needed. See all configuration options in the <a href="../../nais-application/application/#gcpsqlinstances">nais.yaml reference</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="nn">...</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Application</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">gcp</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">sqlInstances</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_12</span><span class="w"></span>
<span class="w">        </span><span class="nt">databases</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mydb</span><span class="w"></span>
</code></pre></div>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">§</a></h2>
<p>To connect your application to the database, use information from the environment variables below.</p>
<p>The prefix <code>NAIS_DATABASE_MYAPP_MYDB</code> is automatically generated from the instance name <code>myapp</code> (defaults to application name) and <code>mydb</code> (from database spec). You can customize these environment variable names by setting <code>.spec.gcp.sqlInstances[].databases[].envVarPrefix</code>. For instance, setting this to <code>DB</code> will give you <code>DB_HOST</code>, <code>DB_USERNAME</code>, etc. Note that changing or adding <code>envVarPrefix</code> requires you to manually delete the <code>google-sql-&lt;MYAPP&gt;</code> secret and <code>SQLUser</code> with the same name as the application, see below.</p>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">environment variable</th>
<th align="left">default</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">hostname</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_HOST</code></td>
<td align="left">127.0.0.1</td>
</tr>
<tr>
<td align="left">port</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_PORT</code></td>
<td align="left">5432</td>
</tr>
<tr>
<td align="left">database name</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_DATABASE</code></td>
<td align="left"><code>.spec.gcp.sqlInstances[].databases[].name</code></td>
</tr>
<tr>
<td align="left">database user</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_USERNAME</code></td>
<td align="left"><code>.spec.gcp.sqlInstances[].name</code></td>
</tr>
<tr>
<td align="left">database password</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_PASSWORD</code></td>
<td align="left">(randomly generated)</td>
</tr>
<tr>
<td align="left">database url with credentials</td>
<td align="left"><code>NAIS_DATABASE_MYAPP_MYDB_URL</code></td>
<td align="left"><code>postgres://username:password@127.0.0.1:5432/mydb</code></td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The application is the only application that can access the database instance. Other applications can not connect. It is not, for instance,
possible to have two applications (e.g. producer and consumer) connecting directly to the database.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Note that if you change your application name, database name or envVarPrefix, and then change it later, 
you have to manually <a href="#reset-database-credentials">reset database credentials</a>.</p>
</div>
<h3 id="query-insights">Query Insights<a class="headerlink" href="#query-insights" title="Permanent link">§</a></h3>
<p>Query insights are now enabled by default in GCP. This feature provides query overview and analysis. 
The data is available in the Google cloud console.</p>
<p>For further reading see <a href="https://cloud.google.com/sql/docs/postgres/query-insights-overview">Google Cloud SQL Query Insights</a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Data is available for seven days, increasing this will incur extra cost.</p>
</div>
<h3 id="maintenance-window">Maintenance window<a class="headerlink" href="#maintenance-window" title="Permanent link">§</a></h3>
<p>Google will automatically perform upgrades, fix bugs and apply security patches to prevent exploits. Your application should be able to handle occasional downtime as this maintenance is performed. Read more on maintenance windows <a href="https://cloud.google.com/sql/docs/postgres/maintenance">here</a>. NAIS does not configure the maintenance window, but this can be set up in the application spec: <a href="../../nais-application/application/#gcpsqlinstances"><code>nais.yaml</code></a>.
If you wish to be notified about upcoming maintenance, you can opt-in for this on the <a href="https://console.cloud.google.com/user-preferences/communication">Communications page</a> in the GCP console.</p>
<h3 id="sizing-your-database">Sizing your database<a class="headerlink" href="#sizing-your-database" title="Permanent link">§</a></h3>
<p>By default, the database server is <code>db-f1-micro</code>, has 1 vCPU, 614 MB RAM and 10GB of SSD storage with no automatic storage increase. If you need to change the defaults you can do this in <a href="../../nais-application/application/#gcpsqlinstancesdisksize"><code>nais.yaml</code></a>.
* Instance settings <a href="https://cloud.google.com/sql/docs/postgres/instance-settings">https://cloud.google.com/sql/docs/postgres/instance-settings</a>
* Shared CPU machine types (<code>db-f1-micro</code> and <code>db-g1-small</code>) are not covered by the <a href="https://cloud.google.com/sql/sla">Cloud SQL SLA</a>.</p>
<h3 id="automated-backup">Automated backup<a class="headerlink" href="#automated-backup" title="Permanent link">§</a></h3>
<p>The database is backed up nightly at 3 AM (GMT+1) by default, but can be overridden in <a href="../../nais-application/application/#gcpsqlinstancesautobackuptime"><code>nais.yaml</code></a> by setting <code>spec.gcp.sqlInstances[].autoBackupTime</code>.
By default, seven backups will be kept. More info <a href="https://cloud.google.com/sql/docs/postgres/backup-recovery/backups">here</a>.</p>
<p>The backups can be found in the <a href="https://cloud.google.com/sql">Google Cloud SQL instance</a> dashboard.</p>
<h4 id="point-in-time-recovery">Point-in-time recovery<a class="headerlink" href="#point-in-time-recovery" title="Permanent link">§</a></h4>
<p>Point-in-time recovery can be enabled by configuring this in the sql instance for your application spec.
This feature allows you to recover your database to a specific point in time. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This feature is not enabled by default. When enabled the Postgres instance will be restarted.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Use this feature with automatic storage increase enabled.</p>
</div>
<p>See application spec reference <a href="https://doc.nais.io/nais-application/application/#gcpsqlinstancespointintimerecovery">here</a>
For further reading see <a href="https://cloud.google.com/sql/docs/postgres/backup-recovery/pitr">google Cloud SQL PIT recovery</a></p>
<h4 id="disaster-backup">Disaster backup<a class="headerlink" href="#disaster-backup" title="Permanent link">§</a></h4>
<p>In case of catastrophic failure in GCP we are running a daily complete backup of the postgresql databases in GCP to an on-prem location. This backup currently runs at 5 am. This is in addition to the regular backups in GCP.</p>
<h2 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">§</a></h2>
<p>Metrics for each Postgres can be found in <a href="https://grafana.nais.io/d/AVwFIm0Mz/cloudsql-gcp?orgId=1">Grafana</a>.</p>
<h2 id="cloud-sql-credentials">Cloud SQL credentials<a class="headerlink" href="#cloud-sql-credentials" title="Permanent link">§</a></h2>
<p>Cloud SQL uses ConfigConnector/CNRM to create and manage all relevant resources (sqldatabase, sqlinstance, sqluser, credentials) for postgreSQL. 
When creating an application via your nais.yaml the database in your google project, along with other necessary resources, are created.
The creation of the database takes about ten minutes, and the credential settings will be updated after the database is ready for use.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you delete and recreate your app new credentials will be created and a synchronization is needed. 
This process can take up to ten minutes. Using the workaround described below you can avoid this synchronization period.</p>
</div>
<h3 id="workaround-for-password-synchronization-issues">Workaround for password synchronization issues<a class="headerlink" href="#workaround-for-password-synchronization-issues" title="Permanent link">§</a></h3>
<p>Retrieve the password from the secret google-sql-<MYAPP> in your namespace (the password is base64 encoded).
<div class="codehilite"><pre><span></span><code>kubectl get secret google-sql-&lt;MYAPP&gt; -o jsonpath=&quot;{ .data[&#39;&lt;YOUR PASSWORD VARIABLE&gt;&#39;] }&quot; | base64 -d
</code></pre></div></p>
<h4 id="through-gcloud-cli">Through gcloud-cli<a class="headerlink" href="#through-gcloud-cli" title="Permanent link">§</a></h4>
<p>Give yourself the role of <code>roles/cloudsql.admin</code> (which includes the needed permission <code>cloudsql.users.update</code>).
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; \
    --member=user:&lt;FIRSTNAME&gt;.&lt;LASTNAME&gt;@nav.no \
    --role=roles/cloudsql.admin \
    --condition=&quot;expression=request.time &lt; timestamp(&#39;$(date -v &#39;+1H&#39; -u +&#39;%Y-%m-%dT%H:%M:%SZ&#39;)&#39;),title=temp_access&quot;
</code></pre></div></p>
<p>Then you can set the new password with the following command.
<div class="codehilite"><pre><span></span><code>gcloud sql users set-password &lt;USERNAME&gt; --instance &lt;DB_INSTANCE&gt; --prompt-for-password
</code></pre></div></p>
<h4 id="through-consolecloudgooglecom">Through console.cloud.google.com<a class="headerlink" href="#through-consolecloudgooglecom" title="Permanent link">§</a></h4>
<p>Log in to the Google <a href="https://console.cloud.google.com">Cloud Console</a> and set the password manually for the application user in the sql instance:
SQL -&gt; <MYDATABASE> -&gt; Users -&gt; <MYAPPUSER> -&gt; Change password</p>
<h3 id="reset-database-credentials">Reset database credentials<a class="headerlink" href="#reset-database-credentials" title="Permanent link">§</a></h3>
<p>To reset the database credentials for your application (if application name, database name or envVarPrefix has been changed):
<div class="codehilite"><pre><span></span><code>$ kubectl delete secret google-sql-&lt;MYAPP&gt;
$ kubectl delete sqluser &lt;MYAPP&gt;
</code></pre></div></p>
<h2 id="cloud-sql-proxy">Cloud SQL Proxy<a class="headerlink" href="#cloud-sql-proxy" title="Permanent link">§</a></h2>
<p>The application will connect to the database using <a href="https://cloud.google.com/sql/docs/postgres/sql-proxy">Cloud SQL Proxy</a>, ensuring that the database communication happens in secure tunnel, authenticated with automatically rotated credentials.</p>
<p>NAIS will add and configure the proxy client container as a sidecar in the pod, making it available on <code>localhost</code> for the application. The application will then connect to the proxy using standard database protocol just as if it was the actual database.</p>
<p><img alt="sqlproxy" src="../../assets/sqlproxy.svg" /></p>
<p>For more detailed information, check out the <a href="https://cloud.google.com/sql/docs/postgres/sql-proxy">Cloud SQL Proxy documentation</a></p>
<h2 id="additional-users-databases">Additional user(s) database(s)<a class="headerlink" href="#additional-users-databases" title="Permanent link">§</a></h2>
<p>You can add users to your database by setting database configuration option: <code>.spec.gcp.sqlInstances[].databases[].users[].name</code>.
Additional users needs to manually be given access to the database and table.
Either directly or with Flyway or other database migration tools.</p>
<p>Names added must match regex: <code>^[_a-zA-Z][_a-zA-Z0-9]+$</code>. Secrets is generated and mounted for each user.</p>
<p>With <code>.spec.gcp.sqlInstances[].databases[].envVarPrefix</code> set to <code>DB</code> and additional username to <code>_user2</code> you will get environment variables in format <code>DB_USER2_MYDB_USERNAME</code> etc.</p>
<p>Details about environment variables is specified her: <a href="./#configuration"><code>configuration</code></a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you've deployed your application with an additional users, and then change name or remove the user from configuration, you need to <em>manually</em> delete the <code>google-sql-&lt;MYAPP&gt;-&lt;USER&gt;</code> secret:
<div class="codehilite"><pre><span></span><code>$ kubectl delete secret google-sql-&lt;MYAPP&gt;-&lt;USER&gt;
</code></pre></div></p>
</div>
<h2 id="personal-database-access">Personal database access<a class="headerlink" href="#personal-database-access" title="Permanent link">§</a></h2>
<p>Databases should always be accessed using a personal account, and the access should ideally be temporary.</p>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">§</a></h3>
<details class="check" open="open">
<summary>Step 1. Install local binaries</summary>
<p>This guide assumes that you have the following installed on your local machine:</p>
<ul>
<li><a href="https://cloud.google.com/sql/docs/postgres/sql-proxy#install">cloudsql-proxy binary</a></li>
<li><a href="https://blog.timescale.com/tutorials/how-to-install-psql-on-mac-ubuntu-debian-windows/">psql binary</a></li>
</ul>
</details>
<details class="check" open="open">
<summary>Step 2. Allow your user to edit Cloud SQL resources for your project</summary>
<p>Ensure that you have authenticated <code>gcloud</code> by running</p>
<div class="codehilite"><pre><span></span><code>gcloud auth login
</code></pre></div>
<p>To be able to perform the gcloud commands mentioned below you need a role with user edit permissions, e.g. <code>roles/cloudsql.admin</code></p>
<p>To grant yourself this role for a given project, run the following command: </p>
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding &lt;project-id&gt; <span class="se">\</span>
    --member user:&lt;your-email&gt; <span class="se">\</span>
    --role roles/cloudsql.admin <span class="se">\</span>
    --condition<span class="o">=</span><span class="s2">&quot;expression=request.time &lt; timestamp(&#39;</span><span class="k">$(</span>date -v <span class="s1">&#39;+1H&#39;</span> -u +<span class="s1">&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span><span class="k">)</span><span class="s2">&#39;),title=temp_access&quot;</span>
</code></pre></div>
<p>where <code>&lt;project-id&gt;</code> can be found by running: </p>
<div class="codehilite"><pre><span></span><code>gcloud projects list <span class="se">\</span>
    --filter<span class="o">=</span>&lt;team&gt;
</code></pre></div>
</details>
<details class="check" open="open">
<summary>Step 3. One-time setup of privileges to SQL IAM users</summary>
<p>This is only required once per database instance and should be done before DDL scripts are run in the database in order to ensure the objects have the right permissions.</p>
<p>Once the database instance is created, we need to grant the IAM users access to the <code>public</code> schema.</p>
<p>This can either be done by using the default application database user during database creation/migration with scripts (e.g. Flyway), or as a one-time setup by using the default <code>postgres</code> user.</p>
</details>
<details class="check" open="open">
<summary>Step 3a. Set password for <code>postgres</code> user</summary>
<p>In order to use the <code>postgres</code> user, you have to set a password first:</p>
<div class="codehilite"><pre><span></span><code>gcloud sql users set-password postgres <span class="se">\</span>
    --instance<span class="o">=</span>&lt;INSTANCE_NAME&gt; <span class="se">\</span>
    --prompt-for-password <span class="se">\</span>
    --project &lt;PROJECT_ID&gt;
</code></pre></div>
</details>
<details class="check" open="open">
<summary>Step 3b. Log in to the database with the <code>postgres</code> user</summary>
<p>Set up the <code>cloudsql-proxy</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">CONNECTION_NAME</span><span class="o">=</span><span class="k">$(</span>gcloud sql instances describe &lt;INSTANCE_NAME&gt; <span class="se">\</span>
    --format<span class="o">=</span><span class="s2">&quot;get(connectionName)&quot;</span> <span class="se">\</span>
    --project &lt;PROJECT_ID&gt;<span class="k">)</span><span class="p">;</span>

cloud_sql_proxy -instances<span class="o">=</span><span class="si">${</span><span class="nv">CONNECTION_NAME</span><span class="si">}</span><span class="o">=</span>tcp:5432
</code></pre></div>
<p>Log in to the database (you will be prompted for the password you set in the previous step):</p>
<div class="codehilite"><pre><span></span><code>psql -U postgres -h localhost &lt;DATABASE_NAME&gt; -W
</code></pre></div>
<p>If you are using Cloud SQL Auth proxy v1.21.0 or newer you can get the token in the cloud_sql_proxy command so you can run the psql-command without the -W parameter:
<div class="codehilite"><pre><span></span><code>cloud_sql_proxy -enable_iam_login -instances<span class="o">=</span><span class="si">${</span><span class="nv">CONNECTION_NAME</span><span class="si">}</span><span class="o">=</span>tcp:5432
</code></pre></div></p>
</details>
<details class="check" open="open">
<summary>Step 3c. Enable privileges for user(s) in database</summary>
<p>This can be enabled for all <code>cloudsqliamusers</code> (all IAM users are assigned the role <code>cloudsqliamuser</code>) with the following command: </p>
<div class="codehilite"><pre><span></span><code><span class="k">alter</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">grant</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">cloudsqliamuser</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Or for a specific user (the given IAM user must exist in the database):</p>
<div class="codehilite"><pre><span></span><code><span class="k">alter</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">grant</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;user@nav.no&#39;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>If your application created the tables before you were able to run these commands, then the owner of the tables is set to the application's user. </p>
<p>Thus, your application must run the following command either through your chosen database migration tool (e.g. Flyway) or manually with the application user's credentials:</p>
<div class="codehilite"><pre><span></span><code><span class="k">grant</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">cloudsqliamuser</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
</details>
<h3 id="granting-temporary-personal-access">Granting temporary personal access<a class="headerlink" href="#granting-temporary-personal-access" title="Permanent link">§</a></h3>
<details class="check" open="open">
<summary>Step 1. Create database IAM user</summary>
<p>This is required once per user and requires that you have create user permission in IAM in your project, e.g. Cloud SQL Admin.</p>
<p>To grant yourself this role for a given project, run the following command: </p>
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding &lt;project-id&gt; <span class="se">\</span>
    --member user:&lt;your-email&gt; <span class="se">\</span>
    --role roles/cloudsql.admin <span class="se">\</span>
    --condition<span class="o">=</span><span class="s2">&quot;expression=request.time &lt; timestamp(&#39;</span><span class="k">$(</span>date -v <span class="s1">&#39;+1H&#39;</span> -u +<span class="s1">&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span><span class="k">)</span><span class="s2">&#39;),title=temp_access&quot;</span>
</code></pre></div>
<p>Then, to create the database IAM user:</p>
<div class="codehilite"><pre><span></span><code>gcloud beta sql users create &lt;FIRSTNAME&gt;.&lt;LASTNAME&gt;@nav.no <span class="se">\</span>
    --instance<span class="o">=</span>&lt;INSTANCE_NAME&gt; <span class="se">\</span>
    --type<span class="o">=</span>cloud_iam_user <span class="se">\</span>
    --project &lt;PROJECT_ID&gt;
</code></pre></div>
</details>
<details class="check" open="open">
<summary>Step 2. Create a temporary IAM binding for 1 hour</summary>
<p>Generally, you should try to keep your personal database access time-limited. </p>
<p>The following command grants your user permission to log into the database for 1 hour.</p>
<p>If your system has GNU utilities installed:</p>
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; <span class="se">\</span>
    --member<span class="o">=</span>user:&lt;FIRSTNAME&gt;.&lt;LASTNAME&gt;@nav.no <span class="se">\</span>
    --role<span class="o">=</span>roles/cloudsql.instanceUser <span class="se">\</span>
    --condition<span class="o">=</span><span class="s2">&quot;expression=request.time &lt; timestamp(&#39;</span><span class="k">$(</span>date --iso-8601<span class="o">=</span>seconds -d <span class="s1">&#39;+1 hours&#39;</span><span class="k">)</span><span class="s2">&#39;),title=temp_access&quot;</span>
</code></pre></div>
<p>Otherwise (e.g. MacOS users):</p>
<div class="codehilite"><pre><span></span><code>gcloud projects add-iam-policy-binding &lt;PROJECT_ID&gt; <span class="se">\</span>
    --member<span class="o">=</span>user:&lt;FIRSTNAME&gt;.&lt;LASTNAME&gt;@nav.no <span class="se">\</span>
    --role<span class="o">=</span>roles/cloudsql.instanceUser <span class="se">\</span>
    --condition<span class="o">=</span><span class="s2">&quot;expression=request.time &lt; timestamp(&#39;</span><span class="k">$(</span>date -v <span class="s1">&#39;+1H&#39;</span> -u +<span class="s1">&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span><span class="k">)</span><span class="s2">&#39;),title=temp_access&quot;</span>
</code></pre></div>
</details>
<details class="check" open="open">
<summary>Step 3. Log in with personal user</summary>
<p>Ensure that the <code>cloudsql-proxy</code> is up and running, if not then:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">CONNECTION_NAME</span><span class="o">=</span><span class="k">$(</span>gcloud sql instances describe &lt;INSTANCE_NAME&gt; <span class="se">\</span>
  --format<span class="o">=</span><span class="s2">&quot;get(connectionName)&quot;</span> <span class="se">\</span>
  --project &lt;PROJECT_ID&gt;<span class="k">)</span><span class="p">;</span>

cloud_sql_proxy -instances<span class="o">=</span><span class="si">${</span><span class="nv">CONNECTION_NAME</span><span class="si">}</span><span class="o">=</span>tcp:5432
</code></pre></div>
<p>Then, connect to the database:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">export</span> <span class="nv">PGPASSWORD</span><span class="o">=</span><span class="k">$(</span>gcloud auth print-access-token<span class="k">)</span>

psql -U &lt;FIRSTNAME&gt;.&lt;LASTNAME&gt;@nav.no -h localhost &lt;DATABASE_NAME&gt; 
</code></pre></div>
</details>
<h2 id="upgrading-major-version">Upgrading major version<a class="headerlink" href="#upgrading-major-version" title="Permanent link">§</a></h2>
<p>In-place database upgrades through <code>nais.yaml</code> is currently not supported. If you attempt to change the version this way, you will get an error message.</p>
<p>In order to upgrade the database version, you will need to follow the Cloud SQL docs on <a href="https://cloud.google.com/sql/docs/postgres/upgrade-major-db-version">upgrading PostgreSQL for an instance</a>.</p>
<h2 id="deleting-the-database">Deleting the database<a class="headerlink" href="#deleting-the-database" title="Permanent link">§</a></h2>
<p>The database is not automatically removed when deleting your NAIS application. Remove unused databases to avoid incurring unnecessary costs. This is done by setting <a href="../../nais-application/application/#gcpsqlinstancescascadingdelete">cascadingDelete</a> in your <code>nais.yaml</code>-specification.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>When you delete an Cloud SQL instance, you cannot reuse the name of the deleted instance until one week from the deletion date.</p>
</div>
<h2 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">§</a></h2>
<p>Check the events on the <a href="https://cloud.google.com/config-connector/docs/overview">Config Connector</a> resources</p>
<div class="codehilite"><pre><span></span><code>$ kubectl describe sqlinstance &lt;myapp&gt;
$ kubectl describe sqldatabase &lt;mydb&gt;
$ kubectl describe sqluser &lt;myapp&gt;
</code></pre></div>
<p>Check the logs of the Cloud SQL Proxy</p>
<div class="codehilite"><pre><span></span><code>$ kubectl logs &lt;pod&gt; -c cloudsql-proxy
</code></pre></div>
<h2 id="example-with-all-configuration-options">Example with all configuration options<a class="headerlink" href="#example-with-all-configuration-options" title="Permanent link">§</a></h2>
<p>See <a href="../../nais-application/example/">full example</a>.</p></main>
            
            
        </div>
    </div>

    

        <footer class="py-3 mt-3 border-top">
    

        
        <p class="text-center">
            
        </p>
        <p class="text-center">
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> and modified <a href="https://sourcefoundry.org/cinder/">Cinder theme</a></small>
        </p>
        

        

    
</footer>


    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap.bundle.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/highlight.min.js"></script>
        

    <script>hljs.highlightAll();</script>
    

    <script>var base_url = "../.."</script>

    

    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal fade" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="searchModalLabel">Search documentation modal</span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close search documentation modal"></button>
            </div>
            <div class="modal-header">
                <form autocomplete="off" class="flex-fill">
                    <div class="form-group">
                        <label class="form-label" id="search-input-label" for="mkdocs-search-query">Search for:</label>
                        <input type="search" class="form-control" placeholder="Type to start searching ..." id="mkdocs-search-query"
                            title="Type search term here" aria-labelledby="search-input-label">

                        <span class="form-text" role="status" id="mkdocs-search-results-info">
                            
                        </span>
                    </div>
                </form>
            </div>
            <div class="modal-body">
                <div aria-label="Search results" id="mkdocs-search-results">
                    
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>

