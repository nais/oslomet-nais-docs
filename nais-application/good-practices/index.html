<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
     <link rel="canonical" href="https://nais.io/oslomet-nais-docs/nais-application/good-practices/"> 
    
    
    <link rel="icon" type="image/x-icon" href="../../assets/logo.svg">
    

    
    <title>Good practices - NAIS</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="../../css/highlight.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <header class="navbar fixed-top navbar-expand-md navbar-dark bg-dark">
    <nav class="container-fluid" aria-label="toolbar">
        
        

            
            <a class="navbar-brand" href="../..">
                <img alt="logo" height="36" src="../../assets/logo.svg" class="align-items-center"/>
                 NAIS platform documentation 
            </a>
            

        

        
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle toolbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        

        
        <div class="navbar-collapse collapse" id="navbarSupportedContent">
            <ul class="navbar-nav flex-grow-1 justify-content-end">
                
                    
                    <li class="nav-item d-grid m-1">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal" type="button">
                            <span class="fas fa-search"></span> Search
                        </button>
                    </li> 
                    
                

                
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../securitycontext/" rel="prev" role="button" class="btn btn-secondary">
                            <span class="fas fa-arrow-left"></span> Previous page
                        </a>
                    </li>
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../debugging/" rel="next" role="button" class="btn btn-secondary">
                            Next page <span class="fas fa-arrow-right"></span>
                        </a>
                    </li>
                    

                    
                

                
                
                    
                        <li class="nav-item my-auto">
                            <a href="https://github.com/nais/oslomet-nais-docs/" class="btn nav-link">
                                
                                    <span class="fab fa-github"></span> NAIS on Github                                    
                                
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </nav>
</header>

    <div class="container-fluid">
        <div class="row">
            
            
                <aside class="col-md-6 col-lg-3 col-xl-2 order-lg-1" aria-label="primary">


<nav class="mb-5 sticky-top sidebar-sticky" aria-labelledby="nav-label">
    <span id="nav-label" class="fs-4">Navigation:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../..

' aria-current="location"><strong>NAIS</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../..">Introduction to NAIS</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../basics/access/

'> Getting started</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../clusters/gcp/

'> Clusters</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../example/

' aria-current="location"><strong>NAIS Application</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../example/">Full example</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../application/">Reference</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../access-policy/">Access policy</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../automatic-scaling/">Automatic scaling</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../config-reloading/">Config reloading</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../ingress/">Ingress customization</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../linkerd/">Linkerd / sidecar customization</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../securitycontext/">Container security context / kernel capabilities</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-warning rounded" href="./" aria-current="page"><strong>Good practices</strong></a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../debugging/">Debugging</a>
        
    </li>

                 
                
            </ul>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../naisjob/

'> Naisjob</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../deployment/

'> Deploy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../observability/alerts/



'> Observability</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../persistence/responsibilities/

'> Persistence</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../security/auth/



'> Security</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../addons/leader-election/

'> Addons</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legacy/sunset/

'> Legacy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../appendix/zero-trust/

'> Appendix</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../../support/">Support</a>
        
    </li>

                 
                
            </ul>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../device/

'> naisdevice</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../cli/

'> nais-cli</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legal/roles-responsibilities/

'> Laws and regulations</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../theme-dev/

'> Theme Dev</a>
        
    </li>



        
    </ul>
</nav>


</aside>
                <aside class="col-md-6 col-lg-3 col-xl-3 order-lg-3" aria-label="secondary"><nav class="mb-5 sticky-top sidebar-sticky " aria-labelledby="toc-label">
    <span id="toc-label" class="fs-4">On this page:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#set-reasonable-resource-requests-and-limits">Set reasonable resource requests and limits</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#handles-termination-gracefully">Handles termination gracefully</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#exposes-relevant-application-metrics">Exposes relevant application metrics</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#writes-structured-logs-to-stdout">Writes structured logs to stdout</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#crashes-on-fatal-errors">Crashes on fatal errors</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#implements-readiness-and-liveness-endpoints">Implements readiness and liveness endpoints</a></strong>
            
        </li>    
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#_1"></a></strong>
            
        </li>    
        
    </ul>
</nav></aside>
                <main class="col-md-12 col-lg-6 col-xl-7 order-lg-2" aria-label="main content">
<div class="mb-2">
    <a href="https://github.com/nais/oslomet-nais-docs/edit/main/docs/nais-application/good-practices.md">
        <span class="fas fa-edit"></span> Edit this page
    </a>
</div>


<p>This document describes the different properties a NAIS application should have.</p>
<h2 id="set-reasonable-resource-requests-and-limits">Set reasonable resource requests and limits<a class="headerlink" href="#set-reasonable-resource-requests-and-limits" title="Permanent link">§</a></h2>
<p>Setting reasonable resource <code>requests</code> and <code>limits</code> helps keep the clusters healthy, while not wasting resources.</p>
<p>A rule of thumb is to set the requested CPU and memory to what your applications uses under "normal" circumstances,
and set limits to what it is reasonable to allow the application to use at most.</p>
<p>Most of the time, the important aspect is <code>requests</code>, because this says how much Kubernetes should reserve for your application.
If you request too much, we are wasting resources.
If you request too little, you run the risk of your application being starved in a low-resource situation.</p>
<p><code>limits</code> is mostly a mechanism to protect the cluster when something goes wrong.
A memory leak that results in your application using all available memory on the node is inconvenient.</p>
<h2 id="handles-termination-gracefully">Handles termination gracefully<a class="headerlink" href="#handles-termination-gracefully" title="Permanent link">§</a></h2>
<p>The application should make sure it listens to the <code>SIGTERM</code> signal, and prepare for shutdown (closing connections etc.) upon receival.</p>
<p>When running on NAIS (or Kubernetes, actually) your application must be able to handle being shut down at any given time. This is because the platform might have to reboot the node your application is running on (e.g. because of a OS patch requiring restart), and in that case will reschedule your application on a different node.</p>
<p>To best be able to handle this in your application, it helps to be aware of the relevant parts of the termination lifecycle.</p>
<ol>
<li>Application (pod) gets status <code>TERMINATING</code>, and grace period starts (default 30s)</li>
<li>(simultaneous with 1) If the pod has a <code>preStop</code> hook defined, this is invoked</li>
<li>(simultaneous with 1) The pod is removed from the list of endpoints i.e. taken out of load balancing</li>
<li>(simultaneous with 1, but after <code>preStop</code> if defined) Container receives <code>SIGTERM</code>, and should prepare for shutdown</li>
<li>Grace period ends, and container receives <code>SIGKILL</code></li>
<li>Pod disappears from the API, and is no longer visible for the client.</li>
</ol>
<p>The platform will automatically add a <code>preStop</code>-hook that pauses the termination sufficiently that e.g. the ingress controller has time to update it's list of endpoints (thus avoid sending traffic to a application while terminating).</p>
<h2 id="exposes-relevant-application-metrics">Exposes relevant application metrics<a class="headerlink" href="#exposes-relevant-application-metrics" title="Permanent link">§</a></h2>
<p>The application should be instrumented using <a href="https://prometheus.io/docs/instrumenting/clientlibs/">Prometheus</a>, exposing the relevant application metrics. See the <a href="../../observability/metrics/">metrics documentation</a> for more info.</p>
<h2 id="writes-structured-logs-to-stdout">Writes structured logs to <code>stdout</code><a class="headerlink" href="#writes-structured-logs-to-stdout" title="Permanent link">§</a></h2>
<p>The application should emit <code>json</code>-formatted logs by writing directly to standard output. This will make it easier to index, view and search the logs later. See more details in the <a href="../../observability/logs/">logs documentation</a>.</p>
<h2 id="crashes-on-fatal-errors">Crashes on fatal errors<a class="headerlink" href="#crashes-on-fatal-errors" title="Permanent link">§</a></h2>
<p>If the application reaches an unrecoverable error, you should let it crash.
Instead, you should immediately exit the process and let the kubelet restart the container.</p>
<p>By restarting the container, you allow for the eventual readiness of other dependencies.</p>
<h2 id="implements-readiness-and-liveness-endpoints">Implements <code>readiness</code> and <code>liveness</code> endpoints<a class="headerlink" href="#implements-readiness-and-liveness-endpoints" title="Permanent link">§</a></h2>
<p>The <code>readiness</code>-probe is used by Kubernetes to determine if the application should receive traffic, while the <code>liveness</code>-probe lets Kubernetes know if your application is alive. If it's dead, Kubernetes will remove the pod and bring up a new one.
They should be implemented as separate services as they usually have different characteristics.</p>
<ul>
<li><code>liveness</code>-probe should simply return <code>HTTP 200 OK</code> if main loop is running, and <code>HTTP 5xx</code> if not.</li>
<li><code>readiness</code>-probe returns <code>HTTP 200 OK</code> is able to process requests, and <code>HTTP 5xx</code> if not. If the application has dependencies to e.g. a database to serve traffic, it's a good idea to check if the database is available in the <code>readiness</code>-probe.</li>
</ul>
<p>Useful resources on the topic:</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</a></li>
<li><a href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes</a></li>
<li><a href="https://medium.com/metrosystemsro/kubernetes-readiness-liveliness-probes-best-practices-86c3cd9f0b4a">https://medium.com/metrosystemsro/kubernetes-readiness-liveliness-probes-best-practices-86c3cd9f0b4a</a></li>
<li><a href="https://blog.colinbreck.com/kubernetes-liveness-and-readiness-probes-revisited-how-to-avoid-shooting-yourself-in-the-other-foot/#letitcrash">https://blog.colinbreck.com/kubernetes-liveness-and-readiness-probes-revisited-how-to-avoid-shooting-yourself-in-the-other-foot/#letitcrash</a></li>
</ul>
<h2 id="_1"><a class="headerlink" href="#_1" title="Permanent link">§</a></h2></main>
            
            
        </div>
    </div>

    

        <footer class="py-3 mt-3 border-top">
    

        
        <p class="text-center">
            
        </p>
        <p class="text-center">
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> and modified <a href="https://sourcefoundry.org/cinder/">Cinder theme</a></small>
        </p>
        

        

    
</footer>


    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap.bundle.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/highlight.min.js"></script>
        

    <script>hljs.highlightAll();</script>
    

    <script>var base_url = "../.."</script>

    

    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal fade" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="searchModalLabel">Search documentation modal</span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close search documentation modal"></button>
            </div>
            <div class="modal-header">
                <form autocomplete="off" class="flex-fill">
                    <div class="form-group">
                        <label class="form-label" id="search-input-label" for="mkdocs-search-query">Search for:</label>
                        <input type="search" class="form-control" placeholder="Type to start searching ..." id="mkdocs-search-query"
                            title="Type search term here" aria-labelledby="search-input-label">

                        <span class="form-text" role="status" id="mkdocs-search-results-info">
                            
                        </span>
                    </div>
                </form>
            </div>
            <div class="modal-body">
                <div aria-label="Search results" id="mkdocs-search-results">
                    
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>

