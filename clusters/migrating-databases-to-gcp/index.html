<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
     <link rel="canonical" href="https://nais.io/oslomet-nais-docs/clusters/migrating-databases-to-gcp/"> 
    
    
    <link rel="icon" type="image/x-icon" href="../../assets/logo.svg">
    

    
    <title>Migrating databases to GCP - NAIS</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="../../css/highlight.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <header class="navbar fixed-top navbar-expand-md navbar-dark bg-dark">
    <nav class="container-fluid" aria-label="toolbar">
        
        

            
            <a class="navbar-brand" href="../..">
                <img alt="logo" height="36" src="../../assets/logo.svg" class="align-items-center"/>
                 NAIS platform documentation 
            </a>
            

        

        
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle toolbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        

        
        <div class="navbar-collapse collapse" id="navbarSupportedContent">
            <ul class="navbar-nav flex-grow-1 justify-content-end">
                
                    
                    <li class="nav-item d-grid m-1">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal" type="button">
                            <span class="fas fa-search"></span> Search
                        </button>
                    </li> 
                    
                

                
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../migrating-to-gcp/" rel="prev" role="button" class="btn btn-secondary">
                            <span class="fas fa-arrow-left"></span> Previous page
                        </a>
                    </li>
                    

                    
                    
                    <li class="nav-item d-grid m-1">
                        <a href="../team-namespaces/" rel="next" role="button" class="btn btn-secondary">
                            Next page <span class="fas fa-arrow-right"></span>
                        </a>
                    </li>
                    

                    
                

                
                
                    
                        <li class="nav-item my-auto">
                            <a href="https://github.com/nais/oslomet-nais-docs/" class="btn nav-link">
                                
                                    <span class="fab fa-github"></span> NAIS on Github                                    
                                
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </nav>
</header>

    <div class="container-fluid">
        <div class="row">
            
            
                <aside class="col-md-6 col-lg-3 col-xl-2 order-lg-1" aria-label="primary">


<nav class="mb-5 sticky-top sidebar-sticky" aria-labelledby="nav-label">
    <span id="nav-label" class="fs-4">Navigation:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../..

' aria-current="location"><strong>NAIS</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../..">Introduction to NAIS</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../basics/access/

'> Getting started</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-grey rounded-top" href='



    

    ../gcp/

' aria-current="location"><strong>Clusters</strong></a>
            <ul class="list-unstyled ps-2 border-start border-bottom py-1">
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../gcp/">Google Cloud Platform</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../on-premises/">On-premises</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../migrating-to-gcp/">Migrating to GCP</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 bg-warning rounded" href="./" aria-current="page"><strong>Migrating databases to GCP</strong></a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../team-namespaces/">Team namespaces</a>
        
    </li>

                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../service-discovery/">Service discovery</a>
        
    </li>

                 
                
            </ul>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../nais-application/example/

'> NAIS Application</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../naisjob/

'> Naisjob</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../deployment/

'> Deploy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../observability/alerts/



'> Observability</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../persistence/responsibilities/

'> Persistence</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    

    



    

    ../../security/auth/



'> Security</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../addons/leader-election/

'> Addons</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legacy/sunset/

'> Legacy</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../appendix/zero-trust/

'> Appendix</a>
        
    </li>


                 
                
            
                    

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href="../../support/">Support</a>
        
    </li>

                 
                
            </ul>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../device/

'> naisdevice</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../cli/

'> nais-cli</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../legal/roles-responsibilities/

'> Laws and regulations</a>
        
    </li>



        

            

    

    <li class="mx-1">
        
            <a class="link-dark link-hover-underline d-block p-1 rounded" href='



    

    ../../theme-dev/

'> Theme Dev</a>
        
    </li>



        
    </ul>
</nav>


</aside>
                <aside class="col-md-6 col-lg-3 col-xl-3 order-lg-3" aria-label="secondary"><nav class="mb-5 sticky-top sidebar-sticky " aria-labelledby="toc-label">
    <span id="toc-label" class="fs-4">On this page:</span>
    <ul class="list-unstyled py-2 mt-3 sidebar-sticky-overflow border-top border-bottom">
        
        <li class="m-1">
            <strong><a class="link-dark link-hover-underline d-block" href="#migrating-databases-to-gcp">Migrating databases to GCP</a></strong>
            
            <ul class="ps-3">
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#migrating-databases-to-gcp-postgresql">Migrating databases to GCP postgreSQL</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#prerequisites">Prerequisites</a>
                    
                </li>
                
                <li class="m-1">
                    <a class="link-dark link-hover-underline d-block" href="#migration-paths-available">Migration paths available</a>
                    
                    <ul class="ps-3">
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#from-on-premise-oracle">From on-premise Oracle</a>
                        </li>
                        
                        <li class="m-1">
                            <a class="link-dark link-hover-underline d-block" href="#from-on-premise-postgresql">From on-premise postgreSQL</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
            
        </li>    
        
    </ul>
</nav></aside>
                <main class="col-md-12 col-lg-6 col-xl-7 order-lg-2" aria-label="main content">
<div class="mb-2">
    <a href="https://github.com/nais/oslomet-nais-docs/edit/main/docs/clusters/migrating-databases-to-gcp.md">
        <span class="fas fa-edit"></span> Edit this page
    </a>
</div>


<h1 id="migrating-databases-to-gcp">Migrating databases to GCP<a class="headerlink" href="#migrating-databases-to-gcp" title="Permanent link">§</a></h1>
<h2 id="migrating-databases-to-gcp-postgresql">Migrating databases to GCP postgreSQL<a class="headerlink" href="#migrating-databases-to-gcp-postgresql" title="Permanent link">§</a></h2>
<p>Suggested patterns for moving on-prem databases to GCP postgreSQL.</p>
<p>Disclaimer: These are options for migrations to GCP postgreSQL. Others may work better for your team.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">§</a></h2>
<p>The team needs to update their ROS and PVK analysis to migrate to GCP. Refer to the ROS and PVK section under <a href="../gcp/">Google Cloud Platform clusters</a>.</p>
<p>See database creation in GCP in <a href="../../persistence/postgres/">Google Cloud Platform persistence</a>.</p>
<h2 id="migration-paths-available">Migration paths available<a class="headerlink" href="#migration-paths-available" title="Permanent link">§</a></h2>
<h3 id="from-on-premise-oracle">From on-premise Oracle<a class="headerlink" href="#from-on-premise-oracle" title="Permanent link">§</a></h3>
<h4 id="replication-migration-using-migration-application">Replication migration using migration application<a class="headerlink" href="#replication-migration-using-migration-application" title="Permanent link">§</a></h4>
<p>Create a simple migration application that supports writing data to the new database. Using requests sent to this application you can populate the new postgreSQL database.</p>
<p>Rewrite the oracle DDL scripts to postgreSQL. If your oracle database contains specific oracle procedures or functions, that do not exist in postgreSQL, they will have to be recreated in some other way. There are tools available to help ease this rewrite, for example ora2pg(<a href="http://ora2pg.darold.net/start.html">http://ora2pg.darold.net/start.html</a>). Create the postgreSQL database in GCP and start deploy the application to GCP with the empty database and let flyway (or other database versioning software) create the DDLs.</p>
<p>Create migration app as a container in the same pod as the database application (this is to avoid permission issues using the same database). This migration application only handles the data transfer from the oracle database to postgreSQL in GCP.</p>
<p>Examples:</p>
<ul>
<li><a href="https://github.com/navikt/pam-stillingsregistrering-api-migration/#pam-stillingsregistrering-api-migration">PAM Stillingsregistrering API Migration</a> (documentation and code)</li>
<li><a href="https://github.com/navikt/pam-ad-migration">PAM AD Migration</a> (no documentation, just code)</li>
<li><a href="https://github.com/navikt/rekrutteringsbistand-kandidat-api-migrering">Rekrutteringsbistand migration</a>  (not using JPA for easier code and less memory-intensive data handling, but as-is only suitable on-premise migration)</li>
</ul>
<p>Trigger migration from command line (or use another form of trigger) and read the data from a feed or kafka.</p>
<p>Pros:</p>
<ul>
<li>No downtime</li>
<li>Live synchronization between on-premise and GCP</li>
<li>Migration controlled entirely by team</li>
<li>Migration can be stopped and restarted at any moment</li>
</ul>
<p>Cons:</p>
<ul>
<li>Can be slow if large amounts of data are to be transferred, if this is the case use kafka for the streaming process instead</li>
<li>Can be tricky for complex databases</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This procedure is also valid for on-premise postgreSQL migration, and even simpler as no rewrite is necessary.</p>
</div>
<h3 id="from-on-premise-postgresql">From on-premise postgreSQL<a class="headerlink" href="#from-on-premise-postgresql" title="Permanent link">§</a></h3>
<h4 id="migration-using-pg_dump">Migration using pg_dump<a class="headerlink" href="#migration-using-pg_dump" title="Permanent link">§</a></h4>
<p>This method is suitable for applications that can have the database in read-only or application that allow for some downtime. It requires that the database instance and DDLs are created up front (i.e. deploy your application in GCP and let flyway create DDLs):</p>
<p>Use docker container image with psql and cloudsdk: <a href="https://github.com/navikt/gcp-migrering">GCP migration image</a>. This image let you do all the following actions from one place.</p>
<p>Deploy the pod into on-premise cluster that can connect to the database</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/navikt/gcp-migrering/main/gcloud.yml
</code></pre></div>
<p><code>exec</code> into that pod</p>
<div class="codehilite"><pre><span></span><code>kubectl <span class="nb">exec</span> -it gcloud /bin/bash
</code></pre></div>
<p>Log in to gcloud with your own NAV-account</p>
<div class="codehilite"><pre><span></span><code>gcloud auth login
</code></pre></div>
<p>Configure the project id (find project id with <code>gcloud projects list --filter team</code>)</p>
<div class="codehilite"><pre><span></span><code>gcloud config <span class="nb">set</span> project &lt;project id&gt;
</code></pre></div>
<p>Create a GCP bucket. You will need the <code>roles/storage.admin</code> IAM role for the required operations on the bucket.</p>
<div class="codehilite"><pre><span></span><code>gsutil mb -l europe-north1 gs://&lt;bucket name&gt;
</code></pre></div>
<p>Find the GCP service account e-mail (the instance id is specified in your <code>nais.yaml</code> file)</p>
<div class="codehilite"><pre><span></span><code>gcloud sql instances describe &lt;CloudSQL instance id&gt; <span class="p">|</span> yq r - serviceAccountEmailAddress
</code></pre></div>
<p>Set the objectAdmin role for the bucket (with the previous e-mail)</p>
<div class="codehilite"><pre><span></span><code>gsutil iam ch serviceAccount:&lt;GCP service account e-mail&gt;:objectAdmin gs://&lt;bucket name&gt;/
</code></pre></div>
<p>Use <code>pg_dump</code> to create the dump file. Notes:</p>
<ul>
<li>Make sure that you stop writes to database before running <code>pg_dump</code>.</li>
<li>Get a <a href="https://github.com/navikt/utvikling/blob/main/docs/teknisk/Vault.md#--hente-ut-postgresql-credentials-til-en-utvikler">database user from Vault</a>.</li>
<li>If the database in GCP already has the <code>flyway_schema_history</code> table, 
  you might want to exclude the equivalent table in the dump by using the <code>--exclude-table=flyway_schema_history</code> option.</li>
</ul>
<div class="codehilite"><pre><span></span><code>pg_dump <span class="se">\</span>
  -h &lt;postgreSQL on-premise host name&gt; <span class="se">\</span>
  -d &lt;database instance name&gt; <span class="se">\</span>
  -U &lt;database user name to connect with&gt; <span class="se">\</span>
  --format<span class="o">=</span>plain --no-owner --no-acl --data-only -Z <span class="m">9</span> &gt; dump.sql.gz
</code></pre></div>
<p>Copy the dump file to GCP bucket</p>
<div class="codehilite"><pre><span></span><code>gsutil -o GSUtil:parallel_composite_upload_threshold<span class="o">=</span>150M -h <span class="s2">&quot;Content-Type:application/x-gzip&quot;</span> cp dump.sql.gz gs://&lt;bucket name&gt;/
</code></pre></div>
<p>Import the dump into the GCP postgreSQL database. Notes:</p>
<ul>
<li>You need the <code>roles/cloudsql.admin</code> IAM role in order to perform the import.</li>
<li>The <code>user</code> in the command below should be a GCP SQL Instance user.</li>
<li>If the GCP Postgres database has any existing tables or sequences, make sure that the <code>user</code> has all required grants for these.</li>
</ul>
<div class="codehilite"><pre><span></span><code>gcloud sql import sql &lt;Cloud SQL instance id&gt; gs://&lt;bucket name&gt;/dump.sql.gz <span class="se">\</span>
  --database<span class="o">=</span>&lt;database instance name&gt; <span class="se">\</span>
  --user<span class="o">=</span>&lt;database instance user name&gt;
</code></pre></div>
<p>Verify that the application is behaving as expected and that the data in the new database is correct. Finally we need to switch loadbalancer to route to the GCP application instead of the on-premise equivalent.</p>
<p>Delete the bucket in GCP after migration is complete</p>
<div class="codehilite"><pre><span></span><code>gsutil -m rm -r gs://&lt;bucket name&gt;
gsutil rb gs://&lt;bucket name&gt;
</code></pre></div>
<p>Pros:</p>
<ul>
<li>Easy and relatively fast migration path</li>
<li>No need for separate migration application or streams to populate database</li>
</ul>
<p>Cons:</p>
<ul>
<li>Requires downtime for the application, or at least no writes to database</li>
<li>Requires node with access to on-premise database and GCP buckets</li>
</ul>
<h4 id="replication-migration-using-migration-application_1">Replication migration using migration application<a class="headerlink" href="#replication-migration-using-migration-application_1" title="Permanent link">§</a></h4>
<p>Same procedure as for Oracle.</p>
<h4 id="replication-migration-using-pgbouncer">Replication migration using pgbouncer<a class="headerlink" href="#replication-migration-using-pgbouncer" title="Permanent link">§</a></h4>
<p>Not available as of now.</p></main>
            
            
        </div>
    </div>

    

        <footer class="py-3 mt-3 border-top">
    

        
        <p class="text-center">
            
        </p>
        <p class="text-center">
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> and modified <a href="https://sourcefoundry.org/cinder/">Cinder theme</a></small>
        </p>
        

        

    
</footer>


    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap.bundle.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.0/build/highlight.min.js"></script>
        

    <script>hljs.highlightAll();</script>
    

    <script>var base_url = "../.."</script>

    

    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal fade" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="searchModalLabel">Search documentation modal</span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close search documentation modal"></button>
            </div>
            <div class="modal-header">
                <form autocomplete="off" class="flex-fill">
                    <div class="form-group">
                        <label class="form-label" id="search-input-label" for="mkdocs-search-query">Search for:</label>
                        <input type="search" class="form-control" placeholder="Type to start searching ..." id="mkdocs-search-query"
                            title="Type search term here" aria-labelledby="search-input-label">

                        <span class="form-text" role="status" id="mkdocs-search-results-info">
                            
                        </span>
                    </div>
                </form>
            </div>
            <div class="modal-body">
                <div aria-label="Search results" id="mkdocs-search-results">
                    
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>

